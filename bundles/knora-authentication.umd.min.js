!function(r,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common/http"),require("@angular/core"),require("@knora/core"),require("moment"),require("rxjs/operators"),require("@angular/router"),require("rxjs"),require("@angular/forms"),require("@angular/common"),require("@angular/material"),require("@knora/action")):"function"==typeof define&&define.amd?define("@knora/authentication",["exports","@angular/common/http","@angular/core","@knora/core","moment","rxjs/operators","@angular/router","rxjs","@angular/forms","@angular/common","@angular/material","@knora/action"],t):t((r.knora=r.knora||{},r.knora.authentication={}),r.ng.common.http,r.ng.core,null,null,r.rxjs.operators,r.ng.router,r.rxjs,r.ng.forms,r.ng.common,r.ng.material,null)}(this,function(r,t,e,i,o,n,s,a,u,l,c,g){"use strict";var p=o,d=function(){function r(r,t,e){this._http=r,this.config=t,this._users=e,this.MAX_SESSION_TIME=864e5}return r.prototype.setSession=function(o,r){var n=this;this._users.getUser(r).subscribe(function(r){var t=!1,e=r.permissions;e.groupsPerProject[i.KnoraConstants.SystemProjectIRI]&&(t=-1<e.groupsPerProject[i.KnoraConstants.SystemProjectIRI].indexOf(i.KnoraConstants.SystemAdminGroupIRI)),n.session={id:n.setTimestamp(),user:{name:r.email,jwt:o,lang:r.lang,sysAdmin:t}},console.log("session service: ",n.session),localStorage.setItem("session",JSON.stringify(n.session))},function(r){console.error(r)})},r.prototype.setTimestamp=function(){return p().add(0,"second").valueOf()},r.prototype.getSession=function(){},r.prototype.updateSession=function(){},r.prototype.validateSession=function(){this.session=JSON.parse(localStorage.getItem("session"));var r=this.setTimestamp();return!!this.session&&(!(this.session.id+this.MAX_SESSION_TIME<r)||(this.authenticate()?(this.session.id=r,console.log("new session id",this.session.id),localStorage.setItem("session",JSON.stringify(this.session)),!0):(this.destroySession(),!1)))},r.prototype.authenticate=function(){return this._http.get(this.config.api+"/v2/authentication").pipe(n.map(function(r){return console.log("AuthenticationService - authenticate - result: ",r),200===r.status}))},r.prototype.destroySession=function(){localStorage.removeItem("session")},r.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:t.HttpClient},{type:i.KuiCoreConfig,decorators:[{type:e.Inject,args:["config"]}]},{type:i.UsersService}]},r.ngInjectableDef=e.defineInjectable({factory:function(){return new r(e.inject(t.HttpClient),e.inject("config"),e.inject(i.UsersService))},token:r,providedIn:"root"}),r}(),f=function(){function r(r,t){this._session=r,this._router=t}return r.prototype.canActivate=function(r,t){return!!this._session.validateSession()||(this._router.navigate(["login"],{queryParams:{returnUrl:t.url}}),!1)},r.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:d},{type:s.Router}]},r.ngInjectableDef=e.defineInjectable({factory:function(){return new r(e.inject(d),e.inject(s.Router))},token:r,providedIn:"root"}),r}(),m=function(){function r(r){this._session=r}return r.prototype.intercept=function(r,t){if(this._session.validateSession()){var e=JSON.parse(localStorage.getItem("session")).user.jwt;r=r.clone({setHeaders:{Authorization:"Bearer "+e}})}else this._session.destroySession();return t.handle(r)},r.decorators=[{type:e.Injectable}],r.ctorParameters=function(){return[{type:d}]},r}(),h=function(){function r(){}return r.prototype.intercept=function(r,t){return t.handle(r).pipe(n.catchError(function(r){console.log("authentication -- error.interceptor",r),r.status;var t=r.error.message||r.statusText;return a.throwError(t)}))},r.decorators=[{type:e.Injectable}],r}(),v=function(){function r(r,t,e){this.http=r,this._session=t,this.config=e}return r.prototype.session=function(){return this._session.validateSession()},r.prototype.login=function(r,t){var e=this;return this.http.post(this.config.api+"/v2/authentication",{identifier:r,password:t},{observe:"response"}).pipe(n.map(function(r){return console.log("authentication service: ",r),r}),n.catchError(function(r){return e.handleRequestError(r)}))},r.prototype.logout=function(){localStorage.removeItem("session")},r.prototype.handleRequestError=function(r){var t=new i.ApiServiceError;return t.status=r.status,t.statusText=r.statusText,t.errorInfo=r.message,t.url=r.url,a.throwError(t)},r.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:t.HttpClient},{type:d},{type:i.KuiCoreConfig,decorators:[{type:e.Inject,args:["config"]}]}]},r.ngInjectableDef=e.defineInjectable({factory:function(){return new r(e.inject(t.HttpClient),e.inject(d),e.inject("config"))},token:r,providedIn:"root"}),r}(),y=function(){function r(r,t,e,o,n){this._auth=r,this._session=t,this._fb=e,this._route=o,this._router=n,this.loading=!1,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.login={title:"Login",name:"Username",pw:"Password",button:"Login",remember:"Remember me",forgot_pw:"Forgot password?",error:{failed:"Password or username is wrong",server:"There's an error with the server connection. Try it again later or inform the Knora Team"}},this.formErrors={email:"",password:""},this.validationMessages={email:{required:"user name is required."},password:{required:"password is required"}}}return r.prototype.ngOnInit=function(){this._session.validateSession()?this.loggedInUser=JSON.parse(localStorage.getItem("session")).user.name:this.buildForm()},r.prototype.buildForm=function(){var t=this;this.frm=this._fb.group({email:["",u.Validators.required],password:["",u.Validators.required]}),this.frm.valueChanges.subscribe(function(r){return t.onValueChanged(r)})},r.prototype.onValueChanged=function(r){var o=this;if(this.frm){var n=this.frm;Object.keys(this.formErrors).map(function(t){o.formErrors[t]="";var r=n.get(t);if(r&&r.dirty&&!r.valid){var e=o.validationMessages[t];Object.keys(r.errors).map(function(r){o.formErrors[t]+=e[r]+" "})}})}},r.prototype.doLogin=function(){var t=this;if(this.errorMessage=undefined,this.loginErrorUser=!1,this.loginErrorPw=!1,this.loginErrorServer=!1,this.frm.invalid)return this.loginErrorPw=!0,void(this.loginErrorUser=!0);this.loading=!0;var e=this.frm.get("email").value,r=this.frm.get("password").value;this._auth.login(e,r).subscribe(function(r){console.log("login-form: ",r),t._session.setSession(r.body.token,e),setTimeout(function(){t.returnUrl=t._route.snapshot.queryParams.returnUrl||"/",t.navigate?t._router.navigate([t.navigate]):t._router.navigate([t.returnUrl]),t.loading=!1},2e3)},function(r){0===r.status&&(t.loginErrorUser=!1,t.loginErrorPw=!1,t.loginErrorServer=!0),401===r.status&&(t.loginErrorUser=!1,t.loginErrorPw=!0,t.loginErrorServer=!1),404===r.status&&(t.loginErrorUser=!0,t.loginErrorPw=!1,t.loginErrorServer=!1),t.errorMessage=r,t.loading=!1})},r.prototype.logout=function(){this._auth.logout(),location.reload(!0)},r.decorators=[{type:e.Component,args:[{selector:"kui-login-form",template:'<div class="login-form" *ngIf="!loggedInUser">\n    <div class="login-form-header">\n        <h3 mat-subheader>{{login.title}}</h3>\n    </div>\n    <div class="login-form-content">\n        \x3c!-- This is the login form --\x3e\n        <form class="login-form" [formGroup]="frm" (ngSubmit)="doLogin()">\n            \x3c!-- Error message --\x3e\n            <mat-hint *ngIf="errorMessage !== undefined" class="full-width">\n                <span *ngIf="loginErrorUser || loginErrorPw">{{login.error.failed}}</span>\n                <span *ngIf="loginErrorServer">{{login.error.server}}</span>\n            </mat-hint>\n\n            \x3c!-- Username --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>person</mat-icon>\n                <input matInput autofocus [placeholder]="login.name" autocomplete="username" formControlName="email">\n                <mat-hint *ngIf="formErrors.email" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Password --\x3e\n            <mat-form-field class="full-width login-field">\n                <mat-icon matPrefix>lock</mat-icon>\n                <input matInput type="password" [placeholder]="login.pw" autocomplete="current-password" formControlName="password">\n                <mat-hint *ngIf="formErrors.password" class="login-error">{{login.error.failed}}</mat-hint>\n            </mat-form-field>\n\n            \x3c!-- Button: Login --\x3e\n            <div class="button-row full-width">\n                <button mat-raised-button type="submit"\n                        *ngIf="!loading"\n                        [disabled]="!frm.valid"\n                        class="full-width submit-button mat-primary">\n                    {{login.button}}\n                </button>\n                <kui-progress-indicator *ngIf="loading" [color]="color"></kui-progress-indicator>\n            </div>\n        </form>\n    </div>\n</div>\n\n\x3c!-- a user is already logged in; show who it is and a logout button --\x3e\n\n<div class="logout-form" *ngIf="loggedInUser">\n    <p>A user is already logged in:</p>\n    <p>{{loggedInUser}}</p>\n    <br>\n    <p>If it\'s not you, please logout!</p>\n    <div class="button-row full-width">\n        <button mat-raised-button\n                (click)="logout()"\n                *ngIf="!loading"\n                class="full-width mat-warn">\n            LOGOUT\n        </button>\n        <kui-progress-indicator *ngIf="loading"></kui-progress-indicator>\n    </div>\n</div>\n',styles:[".full-width{width:100%}.button-row,.mat-form-field,.mat-hint{margin-top:24px}.mat-hint{background:rgba(239,83,80,.39);display:block;margin-left:-16px;padding:16px;text-align:center;width:280px}.login-form,.logout-form{margin-left:auto;margin-right:auto;position:relative;width:280px}.login-form .login-form-header,.logout-form .login-form-header{margin-bottom:24px}.login-form .login-field .mat-icon,.logout-form .login-field .mat-icon{font-size:20px;margin-right:12px}.login-form .button-row,.logout-form .button-row{margin-top:48px}.sign-up{margin-top:24px}"]}]}],r.ctorParameters=function(){return[{type:v},{type:d},{type:u.FormBuilder},{type:s.ActivatedRoute},{type:s.Router}]},r.propDecorators={navigate:[{type:e.Input}],color:[{type:e.Input}]},r}(),I=function(){function r(){}return r.decorators=[{type:e.NgModule,args:[{imports:[l.CommonModule,g.KuiActionModule,c.MatCardModule,c.MatIconModule,c.MatInputModule,c.MatButtonModule,c.MatDialogModule,c.MatFormFieldModule,u.ReactiveFormsModule,t.HttpClientModule],declarations:[y],exports:[y]}]}],r}();r.AuthGuard=f,r.JwtInterceptor=m,r.ErrorInterceptor=h,r.LoginFormComponent=y,r.AuthenticationService=v,r.KuiAuthenticationModule=I,r.ɵa=d,Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=knora-authentication.umd.min.js.map